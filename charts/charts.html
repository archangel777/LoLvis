<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Champions Stats</title>
    <link rel="stylesheet" href="css/dc.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/crossfilter.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/dc.js" charset="utf-8"></script>

</head>
<body>
     <div><h1> Champions Stats</h1>
        <div id="winrate-chart"></div>
        <div id="popular-chart"></div>
    </div>
    <script type="text/javascript"> 
        var winRateByName = d3.map();

        // queue()
        //     .defer(d3.json, "champions.json", function(d) { winRateByName.set(d.name, d.winrate); })
        // var winRateChart = dc.barChart('#winrate-chart');

        // d3.json("champions.json", function(error, data){ 
        //     //criando um crossfilter
        //     var facts = crossfilter(data);

        //     var yearDim = facts.dimension(function(d){
        //         return d.Year;
        //     });

        //     var bilherteriaGroup = yearDim.group().reduceSum(function(d){
        //         return d.Worldwide_Gross_M;
        //     });
        //     barChart.width(800)
        //              .height(400)
        //              .margins({top: 30, right: 50, bottom: 25, left: 40})
        //              .dimension(yearDim)
        //              .xUnits(dc.units.ordinal)
        //              .x(d3.scale.ordinal())
        //              .renderHorizontalGridLines(true)
        //              .legend(dc.legend().x(650).y(10).itemHeight(13).gap(5))
        //              .brushOn(false)
        //              .group(bilherteriaGroup, 'Bilheteria');

        //     dc.renderAll();
        // });

        var winRateChart = dc.barChart('#winrate-chart');

        d3.json("champions.json", function(error, data){ 
            //criando um crossfilter
            var facts = crossfilter(data);

            var championDim = facts.dimension(function(d){
                return d.name;
            });

            var winRateGroup = championDim.group().reduceSum(function(d){
                return d.winrate;
            });

            var sortChampions= data.sort(function (a, b) { return a.winrate < b.winrate; });
            var champions = sortChampions.map(function (d) { return d.name; });

            winRateChart.width(800)
                     .height(400)
                     .margins({top: 30, right: 50, bottom: 25, left: 40})
                     .dimension(championDim)
                     .y(d3.scale.linear().domain([0, 100]))
                     .xUnits(dc.units.ordinal)
                     .x(d3.scale.ordinal().domain(champions))
                     .xAxisLabel("Champions")
                     .yAxisLabel("Win Rate")
                     .renderHorizontalGridLines(true)
                     .legend(dc.legend().x(650).y(10).itemHeight(13).gap(5))
                     .brushOn(false)
                     .group(winRateGroup)
                     .ordering(function(d) { return d.winrate; })
                     .gap(100)
                     .label(function(d){
                        return d.data.ley;
                     })
                     .on('renderlet', function(chart){
                        var barsData = [];
                        var bars = chart.selectAll('.bar').each(function(d) { barsData.push(d); });
                        //Remove old values (if found)
                        d3.select(bars[0][0].parentNode).select('#inline-labels').remove();
                        //Create group for labels 
                        var gLabels = d3.select(bars[0][0].parentNode).append('g').attr('id','inline-labels');

                        for (var i = bars[0].length - 1; i >= 0; i--) {

                            var b = bars[0][i];
                            //Only create label if bar height is tall enough
                            if (+b.getAttribute('height') < 18) continue;

                            gLabels
                                .append("text")
                                .text(barsData[i].data.value)
                                .attr('x', +b.getAttribute('x') + (b.getAttribute('width')/2) )
                                .attr('y', +b.getAttribute('y') + 15)
                                .attr('text-anchor', 'middle')
                                .attr('fill', 'white');
                        }

                    });
                    //  .on('renderlet', function(chart) {
                    //     chart.selectAll('rect').on("click", function(d) {
                    //         console.log("go to page of champion", d);
                    //     });

                    //     chart.selectAll("rect")
                    //     .append("span")
                    //     .text(function(d) {
                    //         console.log(JSON.stringify(d));
                    //         return d3.select(d).data()[0].data.value;
                    //     })
                    // });


            dc.renderAll();
        });
    </script>           
</body>
</html>