<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Champions Stats</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="css/dc.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/crossfilter.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/dc.js" charset="utf-8"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>
    <style>
        #tooltip {
          position: absolute;
          width: auto;
          height: auto;
          padding: 5px;
          background-color: white;
          -webkit-border-radius: 5px;
          -moz-border-radius: 5px;
          border-radius: 5px;
          -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
          -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
          box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
          pointer-events: none;
        }

        #tooltip.hidden {
          display: none;
        }

        #tooltip p {
          margin: 0;
          text-align: center;
          font-family: sans-serif;
          font-size: 12px;
          line-height: 20px;
        }

    </style>

</head>
<body>
     <div>
        <h4> Role Popularity</h4>
        <div id="rolepop-chart"></div>
        <h4> Champions Win Rate Rank</h4>
        <div id="winrate-chart"></div>
        <h4> Champions Popularity Rank</h4>
        <div id="popular-chart"></div>
        <!-- <h4> Popularity Vayne by time</h4>
        <div id="time-chart"></div> -->
        <h4> Popularity By Win Rate</h4>
        <div id="win-pop-scater"></div>
        <div id="tooltip" class="hidden">
            <p><b><span id="name-scatter"></span><span> - </span><span id="role-scatter"></span></b></p>
            <p>win: <span id="win-info-scatter"></span></p>
            <p>pop: <span id="pop-info-scatter"></span></p>
        </div>
        <h4> General Table</h4>
        <table class="table table-hover" id="dc-table-graph">
            <thead>
                <tr class="header">
                    <th>Champion</th>
                    <th>Win Rate</th>
                    <th>Popularity</th>
                    <th>Banishment</th>
                </tr>
            </thead>
        </table>
    </div>
    <script type="text/javascript"> 
        
        var colorBarchart = ["#1E2226"];
        var sizeIconChampion = 64;
        var gapWinRate = 50;

        var winPopByName = d3.map();
        queue()
            .defer(d3.json, "champions.json", function(d) { winPopByName.set(d.name, [+d.winrate,+d.popularity]); });

        var rolePopChart = dc.barChart('#rolepop-chart');
        var winRateChart = dc.barChart('#winrate-chart');
        var popularChart = dc.barChart('#popular-chart');
        var winPopScaterPlot = dc.scatterPlot("#win-pop-scater");
        var dataTable = dc.dataTable('#dc-table-graph');

        d3.json("champions.json", function(error, data){ 

            //criando um crossfilter
            var facts = crossfilter(data);

            var roleDim = facts.dimension(function(d){
                return d.role;
            });

            var popularityByLan = roleDim.group().reduce(
                //understand more : http://animateddata.co.uk/articles/crossfilter/ e https://dc-js.github.io/dc.js/vc/index.html
                function(v,d){
                    v.amount = (v.amount*v.count + d.popularity)/(v.count+1);
                    v.count++;
                    //console.log("ADD");
                    //console.log(JSON.stringify(v));
                    return v;
                },
                function(v,d){
                    v.amount = (v.amount*v.count - d.popularity)/(v.count-1);
                    v.count--;
                    //console.log("REMOVE");
                    //console.log(JSON.stringify(v));
                    return v;
                },
                function(v,d){
                    return {amount:0,count:0};
                }
            );

            // var sortroles= data.sort(function (a, b) { return a.winrate < b.winrate; });
            // var champions = sortChampions.map(function (d) { return d.name; });

            rolePopChart
                .width(800)
                .height(400)
                .margins({top: 50, right: 50, bottom: 50, left: 50})
                .dimension(roleDim)
                .y(d3.scale.linear().domain([0, 100]))
                //.elasticY(true)
                .xUnits(dc.units.ordinal)
                .gap(gapWinRate)
                .x(d3.scale.ordinal())
                .xAxisLabel("Roles")
                .yAxisLabel("Mean Win Rate (%)")
                .renderHorizontalGridLines(true)
                //.brushOn(false)
                .group(popularityByLan)
                .valueAccessor(function (p) {
                    return p.value.amount;
                })
                //.ordering(function(d) { return d.winrate; })
                .gap(gapWinRate)
                .ordinalColors(colorBarchart)
                .on('renderlet', setRoleIcons);
            rolePopChart.render();

            var winDim = facts.dimension(function(d){
                return d.winrate;
            });

            var championDim = facts.dimension(function(d){
                return d.name;
            });

            var champions;
            var winRateGroup = championDim.group().reduce(
                function(v,d){
                    v.amount = (v.amount*v.count + d.winrate)/(v.count+1);
                    v.count++;
                     console.log("ADD");
                    // console.log(JSON.stringify(v));
                    // champions = winDim.top(5);
                    // var nameChampions = [];
                    // for(i=0;i<champions.length;i++){
                    //     nameChampions.push(champions[i].name);
                    // }
                    // console.log(JSON.stringify(nameChampions));
                    // winRateChart.x(d3.scale.ordinal().domain(nameChampions)).render();
                    return v;
                },
                function(v,d){
                    v.amount = (v.amount*v.count - d.winrate)/(v.count-1);
                    v.count--;
                    // console.log("REMOVE");
                    // console.log(JSON.stringify(v));
                    return v;
                },
                function(v,d){
                    champions = []; 
                    return {amount:0,count:0};
                }
            );

            //var sortChampions= winRateGroup.order(d=> d.amount).top(5);
            //var champions = sortChampions.map(function (d) { return d.key; });

            //WIN RATE
            winRateChart
                .width(800)
                .height(400)
                .margins({top: 50, right: 50, bottom: 50, left: 50})
                .dimension(championDim)
                .y(d3.scale.linear().domain([0, 100]))
                .xUnits(dc.units.ordinal)
                .x(d3.scale.ordinal())//.domain(champions))
                .xAxisLabel("Champions")
                .yAxisLabel("Win Rate (%)")
                .renderHorizontalGridLines(true)
                //.brushOn(false)
                .group(winRateGroup)
                .valueAccessor(function (p) {
                    return p.value.amount;
                })
                .ordering(function(d) { return d.winrate; })
                .gap(gapWinRate)
                .ordinalColors(colorBarchart)
                .on('renderlet', setLabelsIcons);
            winRateChart.render();

            var popularGroup = championDim.group().reduce(
                function(v,d){
                    v.amount = (v.amount*v.count + d.popularity)/(v.count+1);
                    v.count++;
                    // console.log("ADD");
                    // console.log(JSON.stringify(v));
                    return v;
                },
                function(v,d){
                    v.amount = (v.amount*v.count - d.popularity)/(v.count-1);
                    v.count--;
                    // console.log("REMOVE");
                    // console.log(JSON.stringify(v));
                    return v;
                },
                function(v,d){
                    return {amount:0,count:0};
                }
            );     

            var sortChampions= data.sort(function (a, b) { return a.popularity < b.popularity; });
            var champions = sortChampions.map(function (d) { return d.name; });

            //POPULARITY
            popularChart
                .width(800)
                .height(400)
                .margins({top: 50, right: 50, bottom: 50, left: 50})
                .dimension(championDim)
                .y(d3.scale.linear().domain([0, 100]))
                .xUnits(dc.units.ordinal)
                .x(d3.scale.ordinal().domain(champions))
                .xAxisLabel("Champions")
                .yAxisLabel("Popularity (%)")
                .renderHorizontalGridLines(true)
                //.brushOn(false)
                .group(popularGroup)
                .valueAccessor(function (p) {
                    return p.value.amount;
                })
                .ordering(function(d) { return d.winrate; })
                .gap(gapWinRate)
                .ordinalColors(colorBarchart)
                .on('renderlet', setLabelsIcons);
            popularChart.render();

            var winDim = facts.dimension(function(d){
                return d.winrate;
            });

            var winMin = +winDim.bottom(1)[0].winrate;
            var winMax = +winDim.top(1)[0].winrate;

            var popDim = facts.dimension(function(d){
                return d.popularity;
            });

            var popMin = +popDim.bottom(1)[0].popularity;
            var popMax = +popDim.top(1)[0].popularity;

            //console.log(winMin+","+winMax+","+popMin+","+popMax);

            var dimScaterplot = facts.dimension(function (d) {
                return [+d.popularity,+d.winrate, d,name];
            });
            var groupScaterplot = dimScaterplot.group().reduce(
                function(v,d){
                    v.pop = d.popularity;
                    v.win = d.winrate;
                    // console.log("ADD");
                    // console.log(JSON.stringify(v));
                    // console.log(JSON.stringify(d));
                    return v;
                },
                function(v,d){
                    v.pop = 0;
                    v.win = 0;
                    // console.log("REMOVE");
                    // console.log(JSON.stringify(v));
                    return v;
                },
                function(v,d){
                    return {pop:0,win:0};
                }
            );

            var border = 2;
            winPopScaterPlot.width(800)
                .height(800)
                .margins({top: 0, right: 50, bottom: 50, left: 50})
                .y(d3.scale.linear().domain([winMin-border, winMax+border]))
                .x(d3.scale.linear().domain([popMin-border, popMax+border]))
                .yAxisLabel("Win Rate")
                .xAxisLabel("Popularity")
                .brushOn(false)
                .clipPadding(10)
                .renderHorizontalGridLines(true)
                .renderVerticalGridLines(true)
                .dimension(dimScaterplot)
                .excludedOpacity(0.5)
                .group(groupScaterplot)
                .keyAccessor(function (p) {
                    return p.value.pop;
                })
                .valueAccessor(function (p) {
                    return p.value.win;
                })
                .symbolSize(8)
                .on('renderlet', setDotsIconScatter);
            winPopScaterPlot.render();

            dataTable.width(800)
                .height(800)
                .dimension(championDim)
                .group(function(d){return "Stats";})
                .columns([
                  function (d) {return d.name;},
                  function (d) {return d.winrate+"%";},
                  function (d) {return d.popularity+"%";},
                  function (d) {return d.banishment+"%";},
                  ])
                .sortBy(function (d) {return d.winrate;})
                .order(d3.ascending)
                .size(10);
            dataTable.render();
        });

        function setRoleIcons(chart){
            //console.log("ON RENDELET");

            //LABEL AND ICON
            //https://stackoverflow.com/questions/25026010/show-values-on-top-of-bars-in-a-barchart
            var barsData = [];
            var bars = chart.selectAll('.bar').each(function(d) { barsData.push(d); });
            //Remove old values (if found)
            d3.select(bars[0][0].parentNode).select('#inline-labels').remove();
            //Create group for labels 
            var gLabels = d3.select(bars[0][0].parentNode).append('g').attr('id','inline-labels');

            for (var i = bars[0].length - 1; i >= 0; i--) {

                var b = bars[0][i];

                //ICON IMAGE
                //https://gist.github.com/mygoare/10340316
                gLabels
                    .append('svg:image')
                    .attr({
                      'xlink:href': 'icons_roles/'+barsData[i].data.key+'.png',
                      x: 0,
                      y: 0,
                      width: sizeIconChampion,
                      height: sizeIconChampion
                    })
                    .attr('x', +b.getAttribute('x') + (b.getAttribute('width')/2) - sizeIconChampion/2 )
                    .attr('y', +b.getAttribute('y') - sizeIconChampion - 16 )
                    .attr('text-anchor', 'middle')
                    .attr('fill', 'red')
                    .on('click',function(d){
                        //console.log(JSON.stringify(d));
                        //action click -> go to page
                        d3.select(b).on('click')();
                    });

                //Only create label if bar height is tall enough
                if (+b.getAttribute('height') < 18) continue;

                //TEXT LABEL
                gLabels
                    .append("text")
                    .text(Number(barsData[i].data.value.amount).toFixed(1)+"%")
                    .attr('x', +b.getAttribute('x') + (b.getAttribute('width')/2) )
                    .attr('y', +b.getAttribute('y') + 24 )
                    .attr('text-anchor', 'middle')
                    .attr('fill', 'white');
            }
        }

        function setLabelsIcons(chart){
            //console.log("ON RENDELET");

            //LABEL AND ICON
            //https://stackoverflow.com/questions/25026010/show-values-on-top-of-bars-in-a-barchart
            var barsData = [];
            var bars = chart.selectAll('.bar').each(function(d) { barsData.push(d); });
            //Remove old values (if found)
            d3.select(bars[0][0].parentNode).select('#inline-labels').remove();
            //Create group for labels 
            var gLabels = d3.select(bars[0][0].parentNode).append('g').attr('id','inline-labels');

            for (var i = bars[0].length - 1; i >= 0; i--) {

                var b = bars[0][i];

                //ICON IMAGE
                //https://gist.github.com/mygoare/10340316
                gLabels
                    .append('svg:image')
                    .attr({
                      'xlink:href': 'icons_champions/'+barsData[i].data.key+'.png',
                      x: 0,
                      y: 0,
                      width: sizeIconChampion,
                      height: sizeIconChampion
                    })
                    .attr('x', +b.getAttribute('x') + (b.getAttribute('width')/2) - sizeIconChampion/2 )
                    .attr('y', +b.getAttribute('y') - sizeIconChampion - 16 )
                    .attr('text-anchor', 'middle')
                    .attr('fill', 'red')
                    .on('click',function(d){
                        //console.log(JSON.stringify(d));
                        //action click -> go to page
                        d3.select(b).on('click')();
                    });

                //Only create label if bar height is tall enough
                if (+b.getAttribute('height') < 18) continue;

                //TEXT LABEL
                gLabels
                    .append("text")
                    .text(Number(barsData[i].data.value.amount).toFixed(1)+"%")
                    .attr('x', +b.getAttribute('x') + (b.getAttribute('width')/2) )
                    .attr('y', +b.getAttribute('y') + 24 )
                    .attr('text-anchor', 'middle')
                    .attr('fill', 'white');
            }
        }

        function setLabelsTime(chart){
            //LABEL AND ICON
            //https://stackoverflow.com/questions/25026010/show-values-on-top-of-bars-in-a-barchart
            var dotsData = [];
            var dots = chart.selectAll('.dot').each(function(d) { dotsData.push(d); });
            //Remove old values (if found)
            d3.select(dots[0][0].parentNode).select('#inline-labels').remove();
            //Create group for labels 
            var gLabels = d3.select(dots[0][0].parentNode).append('g').attr('id','inline-labels');

            for (var i = dots[0].length - 1; i >= 0; i--) {

                var b = dots[0][i];
                //console.log(JSON.stringify(b));
                //console.log(dotsData[i].x+" "+dotsData[i].y);
                //TEXT LABEL
                gLabels
                    .append("text")
                    .text(Number(dotsData[i].data.value.amount).toFixed(1)+"%")
                    .attr('x', +dotsData[i].x)
                    .attr('y', +dotsData[i].y)
                    .attr('text-anchor', 'middle')
                    .attr('fill', colorBarchart);
            }
        }

        function setDotsIconScatter(chart){
            var sizeIcon = 64;
            //ON CLICK BAR
            // chart.selectAll('path').on("click", function(d) {
            //         console.log("go to page of champion", );
            //     });

            var posData = [];
            chart.selectAll('path').each(function(d,i) {
                    //console.log(this);
                    var trans = d3.select(this).attr('transform')+"";
                    if(trans!="null"){
                        //console.log(trans);
                        var pos = trans.substr(trans.indexOf("("),trans.indexOf(")")).split(",");
                        //console.log(pos);
                        posData.push(pos);
                    }
                });

            //LABEL AND ICON
            //https://stackoverflow.com/questions/25026010/show-values-on-top-of-bars-in-a-barchart
            var dotsData = [];
            var dots = chart.selectAll('.symbol').each(function(d) { dotsData.push(d); });
            //Remove old values (if found)
            d3.select(dots[0][0].parentNode).select('#inline-labels').remove();
            //Create group for labels 
            var gLabels = d3.select(dots[0][0].parentNode).append('g').attr('id','inline-labels');

            for (var i = dots[0].length - 1; i >= 0; i--) {

                var b = dots[0][i];
                //console.log(dotsData[i]);
                //ICON IMAGE
                //https://gist.github.com/mygoare/10340316
                gLabels
                    .append('svg:image')
                    .attr({
                      'id':dotsData[i].key[2].name,
                      'role':dotsData[i].key[2].role,
                      'win':dotsData[i].key[1],
                      'pop':dotsData[i].key[0],
                      'xlink:href': 'icons_champions/'+dotsData[i].key[2].name+'.png',
                      x: 0,
                      y: 0,
                      width: sizeIcon,
                      height: sizeIcon
                    })
                    .attr('x', +posData[i][0].split("(")[1]-sizeIcon/2)
                    .attr('y', +posData[i][1].split(")")[0]-sizeIcon/2)
                    .attr('text-anchor', 'middle')
                    .attr('fill', 'red')
                    .on('mouseover',function(d){
                        var name = d3.select(this).attr('id');
                        var role = d3.select(this).attr('role');
                        var win = d3.select(this).attr('win');;
                        var pop = d3.select(this).attr('pop');
                        //var x = d3.select(this).attr('x');
                        //var y = d3.select(this).attr('y');
                        var coordinates = [0, 0];
                        coordinates = d3.mouse(d3.select("body").node()); // obtém a posição do mouse relativa a this
                        var x = coordinates[0];
                        var y = coordinates[1];
                        showTooltip(name,role,win,pop, x, y);
                    })
                    .on("mouseout", function(d){
                        d3.select(this)
                          .style("cursor", "default")
                          .attr("stroke-width", 0)
                          .attr("stroke","none"); //volta ao valor padrão
                        hideTooltip();
                      });
            
                // //Only create label if bar height is tall enough
                // if (+b.getAttribute('height') < 18) continue;

                //TEXT LABEL
                // gLabels
                //     .append("text")
                //     .text(dotsData[i].key[2].name+"/ win: "+Number(dotsData[i].key[0]).toFixed(1)+" / pop: "+Number(dotsData[i].key[1]).toFixed(1))
                //     .attr('x', +posData[i][0].split("(")[1])
                //     .attr('y', +posData[i][1].split(")")[0]+sizeIcon/2+15)
                //     .attr('text-anchor', 'middle')
                //     .style("font-size","10px")
                //     .attr('fill', colorBarchart);
            }
        }

        function showTooltip(name,role,win,pop, x, y){
            //console.log(name+","+win+","+pop+","+x+","+y);
             d3.select("#tooltip")
              .style("left", x + "px")
              .style("top", y + "px");
            d3.select("#tooltip")
              .select("#win-info-scatter")
              .text(Number(win).toFixed(1)+"%");
            d3.select("#tooltip")
              .select("#pop-info-scatter")
              .text(Number(pop).toFixed(1)+"%");
            d3.select("#tooltip")
              .select("#name-scatter")
              .text(name+"");
            d3.select("#tooltip")
              .select("#role-scatter")
              .text(role+"");
            d3.select("#tooltip")
              .classed("hidden", false);
        }

        function hideTooltip(){
            d3.select("#tooltip")
                .classed("hidden", true);
        }
    </script>           
</body>
</html>